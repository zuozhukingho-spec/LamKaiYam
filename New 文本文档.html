<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N.S.B. ÂÖßÈÉ®ÂÆâÂÖ®ÂØ©Êü•Á≥ªÁµ±</title>
    <style>
        /* --- 1. Ë¶ñË¶∫Ê†∏ÂøÉ --- */
        :root {
            --police-dark: #0a2342;
            --police-blue: #0056b3;
            --text-main: #1a1a1a;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 8px 30px rgba(10, 35, 66, 0.2);
            --border: #cadae8;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f4f7fa;
            background-image: 
                linear-gradient(rgba(10, 35, 66, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(10, 35, 66, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        /* --- 2. È†ÇÈÉ®ÁãÄÊÖãÊ¨Ñ --- */
        .top-hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--police-dark); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; box-sizing: border-box; z-index: 100;
        }
        .progress-module {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 4px;
        }
        .progress-track { width: 200px; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #00d2ff; transition: width 0.5s; }

        /* --- 3. ‰∫∫Áâ©Á´ãÁπ™Â±§ --- */
        #character-stage {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 10; pointer-events: none; overflow: hidden;
            transition: opacity 0.5s;
        }
        .character-img {
            position: absolute; left: 50%; bottom: 0;
            height: 85vh; width: auto; max-width: 80vw;
            transform: translateX(-50%) translateZ(0);
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
            animation: float-only 6s ease-in-out infinite; 
            transition: opacity 0.3s ease-in-out; 
            opacity: 0;
        }
        @keyframes float-only {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* --- 4. Â∞çË©±Ê°Ü --- */
        #dialogue-layer {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 1100px; height: 240px; z-index: 50;
            pointer-events: auto; cursor: pointer;
            transition: opacity 0.5s;
        }
        .dialogue-box {
            width: 100%; height: 100%; background: var(--glass);
            border: 1px solid var(--border); border-top: 4px solid var(--police-dark);
            border-radius: 8px; padding: 50px 40px 30px 40px;
            box-sizing: border-box; box-shadow: var(--shadow);
            backdrop-filter: blur(15px); display: flex; flex-direction: column;
        }
        .name-tag {
            position: absolute; top: -22px; left: 40px;
            background: var(--police-dark); color: white; padding: 8px 35px;
            font-size: 1.1rem; border-radius: 4px; display: flex; align-items: center; gap: 10px;
        }
        .name-tag::before { content: ''; display: block; width: 8px; height: 8px; background: #00d2ff; border-radius: 50%; }
        .text-content { font-size: 1.2rem; line-height: 1.6; color: var(--text-main); font-weight: 500; flex: 1; }
        .next-indicator { align-self: flex-end; color: var(--police-blue); font-weight: bold; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }

        /* --- 5. ÈÅäÊà≤ËÄÉÊ†∏Ê®°ÂºèÂÆπÂô® --- */
        #game-stage-wrapper {
            position: absolute;
            top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            width: 95%; max-width: 480px;
            height: auto;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .game-header-area {
            position: relative; height: 140px; width: 100%;
            display: flex; align-items: flex-end; margin-bottom: -5px;
        }
        .mini-char-container {
            position: absolute; right: 0; bottom: 0;
            width: 45%; height: 100%; z-index: 2;
        }
        .mini-char-img {
            width: 100%; height: 100%;
            object-fit: contain; object-position: bottom right;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
        }
        .mini-dialogue-box {
            position: relative; width: 60%;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--police-dark);
            border-radius: 12px 12px 0 12px;
            padding: 12px; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 0.9rem; line-height: 1.4; color: #333;
            z-index: 1; transition: all 0.3s;
        }
        .mini-dialogue-box::after {
            content: ''; position: absolute; bottom: -8px; right: -8px;
            border-width: 10px 10px 0; border-style: solid;
            border-color: var(--police-dark) transparent;
            display: block; width: 0;
        }
        
        .game-frame-container {
            width: 100%; height: 50vh;
            border: 4px solid var(--police-dark);
            border-radius: 10px; overflow: hidden;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; z-index: 10;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* ÈÅäÊà≤ÈñãÂßã/ÈáçË©¶ÈÅÆÁΩ© */
        #game-start-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 20;
        }
        .btn-game-start {
            background: #00d2ff; color: #0a2342;
            border: 2px solid #fff; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold;
            border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 20px #00d2ff;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- ÂÖ®Â±ÄÈÅÆÁΩ©Â±§ --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000; display: flex;
            justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s;
        }
        .btn-start {
            margin-top: 30px; padding: 15px 40px; background: var(--police-dark);
            color: white; border: none; border-radius: 4px; font-size: 1.2rem; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="top-hud">
        <div class="logo-area"><span>üõ°Ô∏è</span> <span>N.S.B. ËÄÉÊ†∏Á≥ªÁµ±</span></div>
        <div class="progress-module">
            <span style="font-size: 0.85rem;">ÈÄ≤Â∫¶</span>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            <span id="progress-text">0%</span>
        </div>
    </div>

    <div id="vn-layers">
        <div id="character-stage">
            <img id="char-img" src="" alt="Character" class="character-img">
        </div>

        <div id="dialogue-layer" onclick="nextStep()">
            <div class="dialogue-box">
                <div class="name-tag" id="speaker-name">SYSTEM</div>
                <div class="text-content" id="text-box">Á≠âÂæÖÈèàÊé•...</div>
                <div class="next-indicator">ÈªûÊìäÁπºÁ∫å ‚ñ∂</div>
            </div>
        </div>
    </div>

    <div id="game-stage-wrapper">
        <div class="game-header-area">
            <div class="mini-dialogue-box" id="mini-dialogue-content">
                <b id="mini-speaker-name">ËæûËçß:</b><br>
                <span id="mini-text">ËØ∑ÂáÜÂ§áÂ•ΩÔºåËÄÉÊ†∏Âç≥Â∞ÜÂºÄÂßã...</span>
            </div>
            <div class="mini-char-container">
                <img id="mini-char-img" src="" class="mini-char-img">
            </div>
        </div>
        <div class="game-frame-container">
            <div id="game-start-mask">
                <button id="btn-game-action" class="btn-game-start" onclick="triggerGameStart()">ÈñãÂßãËÄÉÊ†∏</button>
            </div>
            <iframe id="game-iframe"></iframe>
        </div>
    </div>

    <div id="start-overlay" class="overlay">
        <h1 style="color: var(--police-dark);">üõ°Ô∏è N.S.B. ÂÖ•ËÅ∑ËÄÉÊ†∏</h1>
        <button class="btn-start" onclick="initSystem()">ÈñãÂßãÈèàÊé•</button>
    </div>

    <script>
        // --- Ë≥áÊ∫êÈÖçÁΩÆ ---
        const IMG_NORMAL = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260204194356403.png";
        const IMG_RULES  = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260204193719993.png"; 
        const IMG_CIYING = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260205175449109.png";
        // ÁæΩÂ≤ö & ÁæΩÊôì
        const IMG_TWINS  = "https://cdn.jsdelivr.net/gh/zuozhukingho-spec/my-image-bed@main/uploads/%7Byear%7D/%7Bmonth%7D/%7Bday%7D/%7BfileName%7D_%7Btimestamp%7D%7BextName%7D20260208214019535.png";

        // --- Ê∏∏Êàè 1ÔºöÂàáË•øÁìú Ê∫ê‰ª£Á†Å ---
        const GAME1_SOURCE_CODE = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { margin: 0; background: #ffffff; color: #333; overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; user-select: none; }
canvas { display: block; touch-action: none; cursor: crosshair; }
#ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 10px; z-index: 10; display:flex; flex-direction:column; }
.header-row { display: flex; justify-content: space-between; width: 100%; margin: 0 auto 10px; }
.combo-row { display: flex; justify-content: center; gap: 20px; width: 100%; }
.stat-box { background: rgba(240,240,240,0.9); padding: 5px 15px; border-radius: 20px; border: 2px solid #ddd; font-weight: bold; font-size:16px; white-space:nowrap; }
.combo-box { color: #d35400; border-color: #f39c12; transition: transform 0.1s; }
.combo-active { transform: scale(1.2); }
#flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s; }
#game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; background: rgba(255,255,255,0.95); padding: 20px 40px; border-radius: 10px; border: 3px solid #333; z-index: 100; text-align: center; }
</style>
</head>
<body>
<div id="flash"></div>
<div id="ui">
<div class="header-row"><div class="stat-box">Score: <span id="score">0</span></div><div class="stat-box"><span id="time">60</span>s</div><div class="stat-box" style="color:#f33" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>
<div class="combo-row"><div class="stat-box combo-box" id="cbox">Combo: <span id="combo">0</span></div></div>
</div>
<div id="game-over"><h2 id="end-title">Game Over</h2></div>
<canvas id="c"></canvas>
<script>
const CFG={g:0.025,drag:0.998,time:60,safe:20,p1:[1,2],p2:[2,4],int:2200};
const cvs=document.getElementById('c'), ctx=cvs.getContext('2d');
let W,H; function resize(){W=cvs.width=window.innerWidth;H=cvs.height=window.innerHeight;} window.onresize=resize; resize();
const DATA={BAD:[{t:'Êú®È©¨',c:'#e74c3c'},{t:'ÁóÖÊØí',c:'#c0392b'},{t:'ÈíìÈ±º',c:'#d35400'},{t:'ÂãíÁ¥¢',c:'#2c3e50'}],GOOD:[{t:'Èò≤ÁÅ´Â¢ô',c:'#27ae60'},{t:'VPN',c:'#16a085'},{t:'Âä†ÂØÜ',c:'#1abc9c'}]};
let st={active:false,score:0,combo:0,maxC:0,lives:3,start:0,objs:[],parts:[],blade:[],phase:false,total:0};
window.addEventListener('message',e=>{if(e.data==='START_GAME')start();});
class Itm{constructor(d,tool){this.t=d.t;this.c=d.c;this.tool=tool;this.r=50;this.x=Math.random()*(W*0.8)+W*0.1;this.y=H+60;this.vx=(W/2-this.x+(Math.random()-0.5)*300)/((Math.sqrt(2*CFG.g*(this.y-H*0.35)))/CFG.g);this.vy=-Math.sqrt(2*CFG.g*(this.y-H*0.35));this.a=0;this.sa=(Math.random()-0.5)*0.05;}}
function start(){st={active:true,score:0,combo:0,maxC:0,lives:3,start:Date.now(),objs:[],parts:[],blade:[],phase:false,total:0};document.getElementById('game-over').style.display='none';loop();spawn();}
function spawn(){if(!st.active)return;let p=(Date.now()-st.start)/1000;let n=Math.floor(Math.random()*(CFG.p1[1]-CFG.p1[0]+1))+CFG.p1[0];if(p>=CFG.safe)n=Math.floor(Math.random()*(CFG.p2[1]-CFG.p2[0]+1))+CFG.p2[0];
for(let i=0;i<n;i++){let tool=p<CFG.safe?false:(Math.random()<0.15);let pool=tool?DATA.GOOD:DATA.BAD;if(!tool)st.total++;
setTimeout(()=>{if(st.active)st.objs.push(new Itm(pool[Math.floor(Math.random()*pool.length)],tool));},i*500);}
setTimeout(spawn,CFG.int);}
function end(win,r){st.active=false;document.getElementById('game-over').style.display='block';document.getElementById('end-title').innerText=win?'Èò≤Âæ°ÊàêÂäü':'Èò≤Âæ°Â§±Ë¥•';document.getElementById('end-title').style.color=win?'#27ae60':'#c0392b';
window.parent.postMessage({type:'GAME_OVER',win:win,reason:r,maxCombo:st.maxC,totalTargets:st.total},'*');}
function loop(){ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);if(!st.active)return;
let p=(Date.now()-st.start)/1000, left=Math.max(0,CFG.time-Math.floor(p));
document.getElementById('time').innerText=left;document.getElementById('score').innerText=st.score;document.getElementById('combo').innerText=st.combo;document.getElementById('lives').innerText='‚ù§Ô∏è'.repeat(st.lives);
if(st.combo>st.maxC)st.maxC=st.combo; if(st.combo>0)document.getElementById('cbox').classList.add('combo-active');else document.getElementById('cbox').classList.remove('combo-active');
if(p>=CFG.safe&&!st.phase){st.phase=true;window.parent.postMessage({type:'PHASE_CHANGE'},'*');}
if(left<=0)end(true,'Êó∂Èó¥Âà∞');
st.objs.forEach((o,i)=>{o.x+=o.vx;o.y+=o.vy;o.vy+=CFG.g;o.vx*=CFG.drag;o.a+=o.sa;
ctx.translate(o.x,o.y);ctx.rotate(o.a);ctx.beginPath();ctx.arc(0,0,o.r,0,6.28);ctx.fillStyle=o.c;ctx.fill();
ctx.fillStyle='#fff';ctx.font='bold 20px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(o.t,0,0);ctx.resetTransform();
if(o.y>H+100){if(!o.tool)hit(false,'ÊºèÊéâÊîªÂáª');st.objs.splice(i,1);}});
if(st.blade.length>1){ctx.beginPath();st.blade.forEach((p,i)=>{if(i==0)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y);});ctx.strokeStyle='#00d2ff';ctx.lineWidth=5;ctx.stroke();}
if(st.blade.length>8)st.blade.shift();requestAnimationFrame(loop);}
function hit(good,r){if(good){st.score+=10;st.combo++;}else{st.lives--;st.combo=0;document.getElementById('flash').style.opacity=0.5;setTimeout(()=>document.getElementById('flash').style.opacity=0,100);if(st.lives<=0)end(false,r);}}
window.ontouchstart=e=>{st.blade=[];};window.ontouchmove=e=>{let t=e.touches[0];st.blade.push({x:t.clientX,y:t.clientY});check(t.clientX,t.clientY);};
window.onmousedown=e=>{st.down=true;st.blade=[];};window.onmousemove=e=>{if(st.down){st.blade.push({x:e.clientX,y:e.clientY});check(e.clientX,e.clientY);}};window.onmouseup=e=>st.down=false;
function check(x,y){st.objs.forEach((o,i)=>{if(Math.hypot(o.x-x,o.y-y)<o.r){st.objs.splice(i,1);if(o.tool)hit(false,'ËØØ‰º§ÂèãÂÜõ');else hit(true);}});}
<\/script></body></html>`;

        // --- Ê∏∏Êàè 2ÔºöËäÇÂ•èÈò≤Âæ° Ê∫ê‰ª£Á†Å (ÊîπÔºöCtrl+3 -> U) ---
        const GAME2_SOURCE_CODE = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{--bg:#f8f9fa;--text:#212529;--hl:#fab1a0;--act:#f1c40f;--red:#e74c3c;--blue:#3498db;--green:#2ecc71;}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;user-select:none;overflow:hidden;}
        .hud{width:90%;max-width:800px;display:flex;justify-content:space-between;margin-bottom:20px;font-size:1.5rem;font-weight:800;color:#2c3e50;}
        .status-bar{width:90%;max-width:800px;height:8px;background:#dfe6e9;border-radius:4px;margin-bottom:30px;overflow:hidden;}
        .status-fill{height:100%;width:0%;transition:width 0.1s linear;}
        .status-fill.prep{background:#636e72;} .status-fill.action{background:var(--red);width:100%;}
        .grid-container{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(2,1fr);gap:15px;width:95%;max-width:900px;margin-bottom:30px;opacity:0.5;transition:opacity 0.2s;}
        .grid-container.active{opacity:1;}
        .card{background:#fff;border:2px solid #e9ecef;border-radius:12px;height:100px;display:flex;align-items:center;justify-content:center;text-align:center;padding:5px;box-shadow:0 4px 6px rgba(0,0,0,0.05);transition:transform 0.1s;}
        .card.target{border:4px solid var(--act);transform:scale(1.05);background:#fffdf0;z-index:10;}
        .card.done{opacity:0.2;transform:scale(0.95);background:#ecf0f1;border-color:transparent;}
        .card.wrong{background:var(--red);color:#fff;} .card.rhythm-hit{transform:scale(0.95);border-color:#bdc3c7;}
        .controls{display:flex;gap:15px;width:90%;max-width:800px;}
        .btn{flex:1;padding:25px 5px;border:none;border-radius:15px;font-size:1.1rem;font-weight:bold;color:#fff;opacity:0.5;transition:0.2s;}
        .controls.unlocked .btn{opacity:1;cursor:pointer;} .controls.unlocked .btn:active{transform:translateY(4px);}
        .btn-red{background:var(--red);} .btn-blue{background:var(--blue);} .btn-green{background:var(--green);}
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.98);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:100;}
    </style>
</head>
<body>
<div class="hud"><span>LEVEL <span id="level-num">1</span> / 5</span><span id="state-text">ÂáÜÂ§á</span></div>
<div class="status-bar"><div class="status-fill" id="status-bar"></div></div>
<div class="grid-container" id="grid"></div>
<div class="controls" id="controls">
<button class="btn btn-red" onclick="inp('block')">A Êã¶Êà™</button><button class="btn btn-blue" onclick="inp('antivirus')">S Êü•ÊùÄ</button><button class="btn btn-green" onclick="inp('pass')">D ÊîæË°å</button>
</div>
<div id="overlay"><h1 id="ov-title"></h1></div>
<script>
const BPM=140, BEAT=60000/BPM, LEVELS=5;
const DATA={block:['SQLÊ≥®ÂÖ•','DDOS','‰∏≠Èó¥‰∫∫'],antivirus:['Êú®È©¨','ÂπøÂëä','Èó¥Ë∞ç'],pass:['ctshkpccÊ†°ÁΩë']};
let st={phase:'idle',level:1,items:[],idx:0,usedNet:false,tmr:null,btmr:null}, ac;
const els={grid:document.getElementById('grid'),bar:document.getElementById('status-bar'),lvl:document.getElementById('level-num'),txt:document.getElementById('state-text'),ov:document.getElementById('overlay'),ctrl:document.getElementById('controls')};

window.addEventListener('message',e=>{if(e.data==='START_GAME')init();});
document.addEventListener('keydown',e=>{
    if(st.phase==='action'){const k=e.key.toLowerCase();if(k==='a')inp('block');else if(k==='s')inp('antivirus');else if(k==='d')inp('pass');}
    // ‰øÆÊîπ‰∏∫ÔºöÊåâ‰∏ã 'U' ÈîÆÁõ¥Êé•Ë∑≥ÂÖ≥ (Êó†ÊèêÁ§∫)
    if(e.key.toLowerCase() === 'u') { next(); }
});

function init(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();if(ac.state==='suspended')ac.resume();st.level=1;st.usedNet=false;els.lvl.innerText=1;els.ov.style.display='none';start();}
function snd(t){if(!ac)return;const o=ac.createOscillator(),g=ac.createGain();
if(t==='w'){o.type='triangle';o.frequency.setValueAtTime(800,ac.currentTime);o.frequency.exponentialRampToValueAtTime(400,ac.currentTime+0.1);g.gain.setValueAtTime(0.5,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ac.currentTime+0.1);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+0.15);}
else{const b=ac.createBuffer(1,ac.sampleRate*0.3,ac.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const n=ac.createBufferSource();n.buffer=b;const f=ac.createBiquadFilter();f.type='lowpass';f.frequency.value=600;g.gain.setValueAtTime(0,ac.currentTime);g.gain.linearRampToValueAtTime(0.2,ac.currentTime+0.05);g.gain.linearRampToValueAtTime(0,ac.currentTime+0.3);n.connect(f);f.connect(g);g.connect(ac.destination);n.start();}}

function start(){
    st.idx=0;st.items=[];els.grid.innerHTML='';els.ctrl.classList.remove('unlocked');els.grid.classList.remove('active');
    for(let i=0;i<8;i++){
        let type,name;const sp=!st.usedNet&&(Math.random()<0.25||st.level===5);
        if(sp&&!st.items.some(x=>x.type==='pass')){type='pass';name=DATA.pass[0];st.usedNet=true;}
        else{type=Math.random()>0.5?'block':'antivirus';name=DATA[type][Math.floor(Math.random()*DATA[type].length)];}
        st.items.push({type,name});
        const c=document.createElement('div');c.className='card';c.id='c-'+i;c.innerText=name;els.grid.appendChild(c);
    }
    st.phase='prep';els.txt.innerText="Âê¨ËäÇÂ•è...";els.txt.style.color="#636e72";els.bar.style.width='0%';
    let b=0;st.btmr=setInterval(()=>{if(b<8){snd('w');els.bar.className='status-fill prep';els.bar.style.width=((b+1)/8*100)+'%';const c=document.getElementById('c-'+b);if(c)c.classList.add('rhythm-hit');b++;}else{clearInterval(st.btmr);act();}},BEAT);
}

function act(){
    st.phase='action';els.txt.innerText="Ë°åÂä®ÔºÅ";els.txt.style.color="#e74c3c";els.ctrl.classList.add('unlocked');els.grid.classList.add('active');hl();
    let wc=0,wt=setInterval(()=>{if(st.phase!=='action'){clearInterval(wt);return;}if(wc<8){snd('f');wc++;}else clearInterval(wt);},BEAT);
    let startT=Date.now(),tot=BEAT*8+1000;
    clearInterval(st.tmr);st.tmr=setInterval(()=>{let elp=Date.now()-startT,rem=tot-elp;els.bar.className='status-fill action';els.bar.style.width=(rem/tot*100)+'%';if(rem<=0){fail("Êó∂Èó¥ËÄóÂ∞Ω");}},30);
}

function hl(){document.querySelectorAll('.card').forEach(c=>c.classList.remove('target'));if(st.idx<8){const c=document.getElementById('c-'+st.idx);if(c){c.classList.remove('rhythm-hit');c.classList.add('target');}}}
function inp(t){if(st.phase!=='action'||st.idx>=8)return;const it=st.items[st.idx],c=document.getElementById('c-'+st.idx);
if(t===it.type){c.classList.add('done');st.idx++;if(st.idx>=8)next();else hl();}else{c.classList.add('wrong');fail(t==='pass'?"ÊîæË°å‰∫ÜÂç±Èô©ÁõÆÊ†á":"Êìç‰ΩúÂ§±ËØØ");}}

function next(){
    st.phase='res';clearInterval(st.tmr);
    if(st.level>=LEVELS){
        els.ov.style.display='flex';document.getElementById('ov-title').innerText="‰ªªÂä°ÂÆåÊàê";
        setTimeout(()=>window.parent.postMessage({type:'GAME_OVER',win:true},'*'),1000);
    }else{st.level++;els.lvl.innerText=st.level;setTimeout(start,1000);}
}

function fail(r){
    st.phase='res';clearInterval(st.tmr);clearInterval(st.btmr);
    els.ov.style.display='flex';document.getElementById('ov-title').innerText="Èò≤Âæ°Â§±Ë¥•";
    window.parent.postMessage({type:'GAME_OVER',win:false,reason:r},'*');
}
<\/script></body></html>`;

        const gameState = { step: 0, typing: false, currentGame: 0 };
        const els = {
            speaker: document.getElementById('speaker-name'),
            text: document.getElementById('text-box'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            startOverlay: document.getElementById('start-overlay'),
            charImg: document.getElementById('char-img'),
            vnLayers: document.getElementById('vn-layers'),
            gameWrapper: document.getElementById('game-stage-wrapper'),
            gameIframe: document.getElementById('game-iframe'),
            gameStartMask: document.getElementById('game-start-mask'),
            gameActionBtn: document.getElementById('btn-game-action'),
            miniChar: document.getElementById('mini-char-img'),
            miniSpeaker: document.getElementById('mini-speaker-name'),
            miniText: document.getElementById('mini-text')
        };

        // --- ÂäáÊú¨ÂÖßÂÆπ ---
        const script = [
            { speaker: 'SYSTEM', text: '„ÄêÁ≥ªÁµ±ÊèêÁ§∫„ÄëÁîüÁâ©Ë≠òÂà•ÈÄöÈÅé„ÄÇÊ≠£Âú®Âª∫Á´ãÂä†ÂØÜÈÄöË®ä...', image: null },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'ÁúãËµ∑Êù•‰Ω†Áä∂ÊÄÅ‰∏çÈîôÂòõ!', image: null },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Êó©‰∏äÂ•ΩÔºåÊñ∞ÂÖµ„ÄÇÊàëÊòØ EvaÔºå‰Ω†ÁöÑÂÖ•ËÅ∑ÂºïÂ∞éÂì°„ÄÇ', image: IMG_NORMAL },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Êù•Âà∞ËøôÈáåÔºåÂ∞±ÊÑèÂë≥Ëëó‰Ω†Â∑≤Á∂ìÂáÜÂ§áÂ•ΩÂÖ≥‰∫é„ÄäÁΩëÁªúÂÆâÂÖ®„ÄãËÄÉÊ†∏ÔºåÊàê‰∏∫‰∏ÄÂêçÁΩëÁªúÊâßÊ≥ïËÄÖ‰∫Ü', image: IMG_NORMAL }, 
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'ËÄÉÊ†∏ÂÜÖÂÆπÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫é:ÁóÖÊØíÁ±ªÂûã,Â∏∏ËßÅÁöÑÁΩëÁªúÊîªÂáªÊâãÊÆµ‰ª•ÂèäÂ¶Ç‰ΩïÈò≤ËåÉ,Á§æ‰∫§Â∑•Á®ãÂ≠¶Á≠âÁ≠â', image: IMG_NORMAL },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Ë∂ÅÁé∞Âú®ËÄÉÊ†∏ÂÆòËøòÊ≤°Êù•ÔºåÊàëÂÖàËØ¥Âá†‰∏™ÂÖ≥‰∫éÁ§æ‰∫§Â∑•Á®ãÊ°à‰æã', image: IMG_NORMAL },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Ê°à‰æã‰∏ÄÔºöÂõ†‰∏∫ÂÖçË¥πÁöÑÁ¶èÂà©ËµÑÊ∫êÔºåËøõÂÖ•ÈíìÈ±ºÁΩëÁ´ôÔºåÊàë‰ª¨ÂèëÁé∞Êó∂ÔºåËÑëÊú∫Ë¢´Ê≥®ÂÖ•‰∫ÜÊú®È©¨Á®ãÂ∫èÔºåÁé∞Âú®ËøòÂú®ÂåªÈô¢ÔºåË¶ÅÁü•ÈÅì„ÄäÂÖçË¥πÁöÑÊâçÊòØÊúÄË¥µÁöÑ„Äã', image: IMG_RULES },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Ê°à‰æã‰∫åÔºöÂõ†‰∏∫‰∏ãËΩΩÁ¶èÂà©ËµÑÊ∫êÔºåÂ∞±ÂÖ≥Èó≠‰∫ÜÈò≤ÁÅ´Â¢ôÊàñËÄÖÊùÄÊØíËΩØ‰ª∂Ôºå‰∫≤ÊâãÊääÈò≤Á∫øÂÖ®ÈÉ®Ëß£ÂºÄÔºåÁé∞Âú®Âíå‰∏ä‰∏Ä‰∏™‰∫∫ÊòØÁóÖÂèã', image: IMG_RULES },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Ê°à‰æã‰∏âÔºöÁî®‰ªª‰Ωï‰∏™‰∫∫‰ø°ÊÅØÂú®‰∫íËÅîÁΩëÂíåÊâÄË∞ìÁöÑ‚ÄúÁæéÂ•≥‚Äù‰∫§Êç¢ËÅîÁ≥ªÊñπÂºèÔºåÁÑ∂ÂêéËÑëÊú∫ÊØè‰∏ÄÂàªÈÉΩÂú®Êî∂Âà∞ÂûÉÂúæÈÇÆ‰ª∂ÂíåÁîµ‰ø°', image: IMG_RULES },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text:'Â∏åÊúõËøô‰∫õ‰∫ãÊÉÖ‰Ω†ÈÉΩÊ≤°ÂÅöËøá,ÂìàÂìàÂìà ', image: IMG_RULES },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'Êàë‰ª¨ÊØèÊó∂ÊØèÂàªÈÉΩÂú®‰∏∫Áæ§‰ºóÂÆ£‰º†ÁΩëÁªúÂÆâÂÖ®,‰ΩÜÊòØ‰∏çÊ≥ïÂàÜÂ≠êÊØîÊàë‰ª¨Êõ¥ÊáÇÂ∫îÁî®‰∫∫ÊÄß', image: IMG_RULES },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text:'ÊâÄ‰ª•Â∞±ÈúÄË¶ÅÊàë‰ª¨Âú®‰∫íËÅîÁΩë‰∏äÁª¥Êä§Ê≤ªÂÆâ', image: IMG_RULES },
            { speaker: 'ËåâËéâ(ÂüπË®ìÂÆò)', text: 'ËØ¥‰∫ÜËøô‰πàÂ§öÊó∂Èó¥Â∑ÆÁÇπËøá‰∫ÜÂÖ≥‰∫é Á§æ‰∫§Â∑•Á®ã ÁöÑÊ°à‰æã,Â∏åÊúõ‰Ω†‰∏Ä‰ºöÂú®ËÄÉÊ†∏‰∏≠Â∞±‰∏çË¶ÅÈîô‰∫Ü,Áé∞Âú®Ë∑≥ËΩ¨Âà∞#0375Â∞±ÂèØ‰ª•ÂºÄÂßãËÄÉÊ†∏‰∫Ü~', image: IMG_NORMAL },
            { speaker: 'SYSTEM', text: '„ÄêÈèàÊé•‰∏≠Êñ∑„ÄëËåâËéâ Â∑≤‰∏ãÁ∑ö,Ê≠£Âú®ÈìæÊé•#0375', image: null },
            { speaker: 'Ëæ≠ÁÜí(ËÄÉÊ†∏ÂÆò)', text: '‰πÖÁ≠â‰∫ÜÔºåÊàëË¥üË¥£ÁöÑËÄÉÊ†∏ÂÜÖÂÆπÊòØÁΩëÁªúÊîªÂáªÊâãÊÆµÂíåÂ∫îÂØπÊñπÊ≥ï', image: IMG_CIYING },
            { speaker: 'Ëæ≠ÁÜí(ËÄÉÊ†∏ÂÆò)', text: '‰Ω†ÈúÄË¶ÅÁ≤æÂáÜÂàÜËæ®ÁóÖÊØíÊàñÊîªÂáªÊâãÊÆµÔºåÂ∞Ü‰ªñ‰ª¨ÂÖ®ÈÉ®Èì≤Èô§ÔºåÈÄî‰∏≠Ê≥®ÊÑè‰∏çË¶ÅÊîªÂáªÂèãÂÜõÔºÅ', image: IMG_CIYING },
            { type: 'GAME1_PREPARE' },
        ];

        function preloadImages() {
            [IMG_NORMAL, IMG_RULES, IMG_CIYING, IMG_TWINS].forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        function initSystem() {
            preloadImages();
            els.startOverlay.style.opacity = '0';
            setTimeout(() => { els.startOverlay.style.display = 'none'; }, 500);
            renderStep();
        }

        function updateProgress() {
            const percentage = Math.floor(((gameState.step + 1) / script.length) * 100);
            els.progressBar.style.width = percentage + '%';
            els.progressText.innerText = percentage + '%';
        }

        function renderStep() {
            const currentScript = script[gameState.step];
            
            if (currentScript.type === 'GAME1_PREPARE') {
                prepareGame(1, IMG_CIYING, "ËæûËçß", "ËØ∑ÂáÜÂ§áÂ•ΩÔºåËÄÉÊ†∏Âç≥Â∞ÜÂºÄÂßã...", GAME1_SOURCE_CODE);
                return;
            }
            if (currentScript.type === 'GAME2_PREPARE') {
                prepareGame(2, IMG_TWINS, "ÁæΩÂ≤ö & ÁæΩÊôì", "Âê¨Â•ΩËäÇÂ•èÔºåÈò≤Âæ°Âç≥Â∞ÜÂºÄÂßã...", GAME2_SOURCE_CODE);
                return;
            }

            // Â¶ÇÊûúÊòØÊñáÊú¨Â∞çË©±ÔºåÁ¢∫‰øùÈ°ØÁ§∫ VN Â±§
            if (!currentScript.type) {
                // Â¶ÇÊûú VN Â±§ÊòØÈö±ËóèÁöÑÔºåÁ¢∫‰øùÂÆÉÈ°ØÁ§∫Âá∫‰æÜ
                if (els.vnLayers.style.display === 'none') {
                     els.vnLayers.style.display = 'block';
                     els.vnLayers.style.opacity = '1';
                }
            }

            if (currentScript.image) {
                if (els.charImg.src !== currentScript.image) {
                    if (els.charImg.style.opacity === '1') {
                        els.charImg.style.opacity = '0';
                        setTimeout(() => {
                            els.charImg.src = currentScript.image;
                            els.charImg.style.opacity = '1';
                        }, 300);
                    } else {
                        els.charImg.src = currentScript.image;
                        setTimeout(() => els.charImg.style.opacity = '1', 50);
                    }
                } else {
                    els.charImg.style.opacity = '1';
                }
            } else {
                els.charImg.style.opacity = '0';
            }

            els.speaker.innerText = currentScript.speaker;
            els.speaker.style.background = currentScript.speaker.includes('SYSTEM') ? '#555' : 'var(--police-dark)';
            els.text.innerHTML = '';
            gameState.typing = true;
            let i = 0;
            const content = currentScript.text;
            
            function typeWriter() {
                if (i < content.length) {
                    els.text.innerHTML += content.charAt(i) === '\n' ? '<br>' : content.charAt(i);
                    i++;
                    setTimeout(typeWriter, 25);
                } else {
                    gameState.typing = false;
                }
            }
            typeWriter();
            updateProgress();
        }

        function nextStep() {
            if (gameState.typing) return;
            gameState.step++;
            if (gameState.step < script.length) {
                renderStep();
            } else {
                console.log("End of script");
            }
        }

        function prepareGame(gameId, charImg, speakerName, initialText, sourceCode) {
            gameState.currentGame = gameId;
            // Èö±ËóèÂ∞çË©±Â±§
            els.vnLayers.style.opacity = '0';
            setTimeout(() => {
                els.vnLayers.style.display = 'none';
                els.gameWrapper.style.display = 'flex';
                
                els.miniChar.src = charImg;
                els.miniSpeaker.innerText = speakerName + ":";
                updateMiniText(initialText);
                
                els.gameIframe.srcdoc = sourceCode;
                els.gameStartMask.style.display = 'flex';
                els.gameActionBtn.innerText = "ÈñãÂßãËÄÉÊ†∏";
            }, 500);

            els.progressBar.style.width = '100%';
            els.progressText.innerText = 'ËÄÉÊ†∏Ê∫ñÂÇô';
        }

        function triggerGameStart() {
            els.gameStartMask.style.display = 'none';
            const iframeWin = els.gameIframe.contentWindow;
            iframeWin.postMessage('START_GAME', '*');
            if(gameState.currentGame === 1) updateMiniText("Â∏åÊúõ‰Ω†ÁúüÁöÑÂÅöÂ•Ω‰∫ÜÂáÜÂ§á");
            else updateMiniText("ÈõÜ‰∏≠Ê≥®ÊÑèÂäõÔºåË∑ü‰∏äËäÇÂ•èÔºÅ");
        }

        function updateMiniText(text) {
            els.miniText.innerText = text;
        }

        function backToVN() {
            // Èö±ËóèÈÅäÊà≤Â±§ÔºåÈ°ØÁ§∫Â∞çË©±Â±§
            els.gameWrapper.style.display = 'none';
            els.vnLayers.style.display = 'block';
            // Âº∑Âà∂ÈáçÁπ™Á¢∫‰øù transition ÁîüÊïà
            void els.vnLayers.offsetWidth; 
            els.vnLayers.style.opacity = '1';
        }

        window.addEventListener('message', function(e) {
            const data = e.data;
            if (!data.type) return;

            if (data.type === 'PHASE_CHANGE') {
                updateMiniText("Áé∞Âú®ÂºÄÂßãÂá∫Áé∞Èò≤Âæ°ÊâãÊÆµ‰∫ÜÂìüÔºåÊ≥®ÊÑèÊïåÊàëËØÜÂà´");
            } 
            else if (data.type === 'GAME_OVER') {
                if (!data.win) {
                    updateMiniText((data.reason || "ËÄÉÊ†∏Â§±Ë¥•") + "Ôºå‰Ω†ÈúÄË¶ÅÈáçÊñ∞ÂºÄÂßãËÄÉÊ†∏");
                    setTimeout(() => {
                        els.gameStartMask.style.display = 'flex';
                        els.gameActionBtn.innerText = "ÈáçÊñ∞ËÄÉÊ†∏";
                    }, 500); 
                } else {
                    if (gameState.currentGame === 1) {
                        updateMiniText("Ë°®Áé∞‰∏çÈîôÔºåÂ®ÅËÉÅÊ∏ÖÈô§");
                        setTimeout(() => {
                            // 1. ÂàáÊèõÂõûÂ∞çË©±Ê®°Âºè
                            backToVN();
                            
                            // 2. Ê∫ñÂÇôÂäáÊú¨
                            const isPerfect = (data.maxCombo === data.totalTargets) && (data.totalTargets > 0);
                            const resultText = isPerfect 
                                ? "ÊÅ≠Âñú‰Ω†ÂÆåÁæéÈÄöËøá‰∫ÜÊú¨Ê¨°ËÄÉÊ†∏Ôºå‰Ω†ÂèØ‰ª•ÂéªÊâæ‰∏ã‰∏Ä‰∏™ËÄÉÂÆò‰∫Ü" 
                                : "‰∏îÁÆóÂ∑≤ÈÄöËøáÁöÑÊú¨Ê¨°ËÄÉÊ†∏Ôºå‰Ω†ÂèØ‰ª•ÂéªÊâæ‰∏ã‰∏Ä‰∏™ËÄÉÂÆò‰∫Ü";
                            
                            // ÊèíÂÖ•ÂæåÁ∫åÂ∞çË©±
                            script.splice(gameState.step + 1, 0, 
                                { speaker: 'Ëæ≠ÁÜí(ËÄÉÊ†∏ÂÆò)', text: resultText, image: IMG_CIYING },
                                { speaker: 'SYSTEM', text: 'Ê≠£Âú®Ë∑≥ËΩ¨#7098', image: null },
                                { speaker: 'ÁæΩÂ≤ö & ÁæΩÊôì', text: '‰Ω†Â•ΩËÄÉÁîüÈÄöËøáÊàë‰ª¨ÁöÑËÄÉÈ™å‰Ω†Â∞±ËÉΩÂÆåÊàêËÄÉÈ™å,Êàê‰∏∫‰∏ÄÂêçÊâßÊ≥ï‰∫∫Âëò‰∫Ü!', image: IMG_TWINS },
                                { type: 'GAME2_PREPARE' }
                            );

                            // 3. ÊâãÂãïÊé®ÈÄ≤‰∏ÄÊ≠•‰∏¶Âº∑Âà∂Ê∏≤ÊüìÔºåÁ¢∫‰øù‰∏çÊúÉÂõ†ÁÇ∫ display:none Ë¢´Ë∑≥ÈÅé
                            gameState.step++;
                            setTimeout(renderStep, 100); 

                        }, 2000);

                    } else if (gameState.currentGame === 2) {
                        updateMiniText("ËäÇÂ•èÂÆåÁæéÔºåÈò≤Âæ°ÊàêÂäüÔºÅ");
                        setTimeout(() => {
                            backToVN();
                            script.splice(gameState.step + 1, 0, 
                                { speaker: 'ÁæΩÂ≤ö & ÁæΩÊôì', text: 'ÊÅ≠Âñú‰Ω†ÔºÅÊ¨¢ËøéÂä†ÂÖ• N.S.B.ÔºåÊñ∞ÁöÑÊâßÊ≥ïËÄÖ„ÄÇ', image: IMG_TWINS },
                                { speaker: 'SYSTEM', text: '„ÄêËÄÉÊ†∏ÁªìÊùü„ÄëÊ°£Ê°àÂΩïÂÖ•ÂÆåÊàê„ÄÇ', image: null }
                            );
                            gameState.step++;
                            setTimeout(renderStep, 100);
                        }, 2000);
                    }
                }
            }
        });
    </script>
</body>
</html>